"""Vulnerability scan model for tracking container vulnerability scans."""

from sqlalchemy import JSON, Column, DateTime, Float, ForeignKey, Integer, String
from sqlalchemy.sql import func

from app.database import Base


class VulnerabilityScan(Base):
    """Container vulnerability scan results from VulnForge."""

    __tablename__ = "vulnerability_scans"

    id = Column(Integer, primary_key=True, autoincrement=True)
    container_id = Column(
        Integer, ForeignKey("containers.id"), nullable=False, index=True
    )

    # Scan metadata
    scanned_at = Column(DateTime(timezone=True), server_default=func.now())
    status = Column(String, default="completed")  # pending, completed, failed
    error_message = Column(String, nullable=True)

    # Vulnerability counts
    total_vulns = Column(Integer, default=0)
    critical_count = Column(Integer, default=0)
    high_count = Column(Integer, default=0)
    medium_count = Column(Integer, default=0)
    low_count = Column(Integer, default=0)

    # Vulnerability details
    cves = Column(JSON, default=lambda: [], server_default="[]")  # List of CVE IDs
    risk_score = Column(Float, nullable=True)  # Optional risk score

    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(
        DateTime(timezone=True), server_default=func.now(), onupdate=func.now()
    )

    def __repr__(self):
        return f"<VulnerabilityScan(container_id={self.container_id}, total_vulns={self.total_vulns})>"
