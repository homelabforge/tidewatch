"""Add vulnerability_scans table for storing VulnForge scan results."""

from sqlalchemy import text


async def upgrade(db):
    """Create vulnerability_scans table."""
    await db.execute(text("""
        CREATE TABLE IF NOT EXISTS vulnerability_scans (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            container_id INTEGER NOT NULL,
            scanned_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            status TEXT DEFAULT 'completed',
            error_message TEXT,
            total_vulns INTEGER DEFAULT 0,
            critical_count INTEGER DEFAULT 0,
            high_count INTEGER DEFAULT 0,
            medium_count INTEGER DEFAULT 0,
            low_count INTEGER DEFAULT 0,
            cves TEXT DEFAULT '[]',
            risk_score REAL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE
        )
    """))

    # Create index on container_id for faster lookups
    await db.execute(text("""
        CREATE INDEX IF NOT EXISTS idx_vulnerability_scans_container_id
        ON vulnerability_scans(container_id)
    """))

    await db.commit()


async def downgrade(db):
    """Drop vulnerability_scans table."""
    await db.execute(text("DROP INDEX IF EXISTS idx_vulnerability_scans_container_id"))
    await db.execute(text("DROP TABLE IF EXISTS vulnerability_scans"))
    await db.commit()
