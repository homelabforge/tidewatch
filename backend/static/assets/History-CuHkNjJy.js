import{a as d,j as e}from"./index-Co59pYVW.js";import{r as x}from"./router-vendor-h5EZ-JED.js";import{S as y}from"./StatusBadge-Dt8L00S1.js";import{t as n,R as l,a as f,p as r,z as j}from"./ui-vendor-TZ6_hWVS.js";import{f as o}from"./utils-vendor-DnsfCnls.js";import"./react-vendor-C6WxKkic.js";const g=s=>{if(!s)return"Unknown";if(s.startsWith("manual")){const a=s.split(":");return a.length>1?a[1].trim():"Manual Restart"}return{exit_code:"Container Exited",health_check:"Health Check Failed",oom_killed:"Out of Memory",signal_killed_SIGKILL:"Killed (SIGKILL)",signal_killed_SIGTERM:"Terminated (SIGTERM)",manual:"Manual Restart"}[s]||s.replace(/_/g," ")};function M(){const[s,p]=x.useState([]),[a,m]=x.useState(!0);x.useEffect(()=>{i()},[]);const i=async()=>{m(!0);try{const t=await d.history.getAll();p(t)}catch{n.error("Failed to load history")}finally{m(!1)}},h=async t=>{if(confirm("Are you sure you want to rollback this update? This will restore the previous version."))try{await d.history.rollback(t),n.success("Rollback initiated successfully"),i()}catch{n.error("Failed to rollback update")}},u=async t=>{if(console.log("Unignore clicked - Full item:",t),console.log("Dependency fields:",{id:t.dependency_id,type:t.dependency_type,container:t.container_id,name:t.dependency_name}),!t.dependency_id||!t.dependency_type||!t.container_id){n.error(`Missing dependency information (ID: ${t.dependency_id}, Type: ${t.dependency_type}, Container: ${t.container_id})`);return}try{t.dependency_type==="dockerfile"?await d.dependencies.unignoreDockerfile(t.dependency_id):t.dependency_type==="http_server"?await d.dependencies.unignoreHttpServer(t.dependency_id):t.dependency_type==="app_dependency"&&await d.dependencies.unignoreAppDependency(t.dependency_id),n.success(`Unignored ${t.dependency_name||"dependency"}`),i()}catch(c){console.error("Unignore error:",c),n.error("Failed to unignore dependency")}};return e.jsx("div",{className:"min-h-screen bg-tide-bg",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-tide-text",children:"History"}),e.jsx("p",{className:"text-tide-text-muted mt-2",children:"View container updates and restart events"})]}),e.jsxs("button",{onClick:i,disabled:a,className:"px-4 py-2 bg-primary hover:bg-primary-dark text-tide-text rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center gap-2",children:[e.jsx(l,{size:16,className:a?"animate-spin":""}),"Refresh"]})]}),a?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(l,{className:"animate-spin mx-auto mb-4 text-primary",size:48}),e.jsx("p",{className:"text-tide-text-muted",children:"Loading history..."})]}):s.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(f,{className:"mx-auto mb-4 text-gray-600",size:48}),e.jsx("p",{className:"text-tide-text-muted",children:"No history found"}),e.jsx("p",{className:"text-sm text-tide-text-muted mt-2",children:"Container updates and restarts will appear here"})]}):e.jsxs("div",{className:"bg-tide-surface border border-tide-border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-tide-surface border-b border-tide-border",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Container"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Event"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Started"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Duration"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Performed By"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-tide-text-muted uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-tide-border",children:s.map(t=>{const c=t.completed_at?Math.round((new Date(t.completed_at).getTime()-new Date(t.started_at).getTime())/1e3):null;return e.jsxs("tr",{className:"hover:bg-tide-surface-light transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-tide-text",children:t.container_name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.event_type==="update"?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-tide-text",children:[e.jsx("span",{className:"font-mono",children:t.from_tag}),e.jsx(r,{size:14,className:"text-tide-text-muted"}),e.jsx("span",{className:"font-mono text-primary",children:t.to_tag})]}):t.event_type==="dependency_update"?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-tide-text",children:[e.jsx(r,{size:14,className:"text-primary"}),e.jsx("span",{className:"font-medium",children:t.dependency_name||"Dependency"}),e.jsx("span",{className:"font-mono text-xs",children:t.from_tag}),e.jsx(r,{size:12,className:"text-tide-text-muted"}),e.jsx("span",{className:"font-mono text-xs text-primary",children:t.to_tag})]}):t.event_type==="dependency_ignore"?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-tide-text",children:[e.jsx("span",{className:"font-medium",children:t.dependency_name||"Dependency"}),e.jsx("span",{className:"font-mono text-xs",children:t.from_tag}),e.jsx(r,{size:12,className:"text-tide-text-muted"}),e.jsx("span",{className:"font-mono text-xs text-primary",children:t.to_tag})]}):t.event_type==="dependency_unignore"?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-tide-text",children:[e.jsx("span",{className:"font-medium",children:t.dependency_name||"Dependency"}),e.jsx("span",{className:"font-mono text-xs",children:t.from_tag}),e.jsx(r,{size:12,className:"text-tide-text-muted"}),e.jsx("span",{className:"font-mono text-xs text-primary",children:t.to_tag})]}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-tide-text",children:[e.jsx(l,{size:14,className:"text-blue-400"}),e.jsx("span",{className:"capitalize",children:g(t.trigger_reason)}),t.exit_code!==null&&t.exit_code!==void 0&&e.jsxs("span",{className:"text-xs text-tide-text-muted",children:["(exit ",t.exit_code,")"]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx(y,{status:t.status,event_type:t.event_type})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-tide-text",children:o(new Date(t.started_at),"MMM d, yyyy")}),e.jsx("div",{className:"text-xs text-tide-text-muted",children:o(new Date(t.started_at),"HH:mm:ss")})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-tide-text",children:c!==null?`${c}s`:"In progress"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-tide-text",children:t.performed_by||"System"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.event_type==="update"&&t.rollback_available&&e.jsxs("button",{onClick:()=>h(t.id),className:"flex items-center gap-1 px-3 py-1.5 bg-tide-surface hover:bg-tide-surface-light text-tide-text rounded text-xs font-medium transition-colors",children:[e.jsx(j,{size:12}),"Rollback"]}),t.event_type==="dependency_ignore"&&e.jsxs("button",{onClick:()=>u(t),className:"flex items-center gap-1 px-3 py-1.5 bg-teal-500/20 hover:bg-teal-500/30 text-teal-400 rounded text-xs font-medium transition-colors border border-teal-500/30",children:[e.jsx(l,{size:12}),"Unignore"]})]})]},`${t.event_type}-${t.id}`)})})]})}),s.some(t=>t.error_message)&&e.jsxs("div",{className:"border-t border-tide-border p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-tide-text mb-3",children:"Recent Errors"}),e.jsx("div",{className:"space-y-2",children:s.filter(t=>t.error_message).slice(0,5).map(t=>e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-md p-3",children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsxs("span",{className:"text-sm font-medium text-tide-text",children:[t.container_name," (",t.event_type,")"]}),e.jsx("span",{className:"text-xs text-tide-text-muted",children:o(new Date(t.started_at),"MMM d, HH:mm")})]}),e.jsx("p",{className:"text-xs text-red-400",children:t.error_message})]},`error-${t.event_type}-${t.id}`))})]})]})]})})}export{M as default};
